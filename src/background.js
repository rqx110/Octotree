(()=>{"use strict";const e=globalThis.chrome&&new function e(t){return new Proxy(t,{get:(t,n)=>"function"!=typeof t[n]?new e(t[n]):(...e)=>new Promise(((o,r)=>{t[n](...e,(e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):o(e)}))}))})}(globalThis.chrome),t="object"==typeof chrome&&"scripting"in chrome;function n(e){return void 0===e?void 0:[e]}const o=/^(https?|wss?|file|ftp|\*):\/\/(\*|\*\.[^*/]+|[^*/]+)\/.*$|^file:\/\/\/.*$|^resource:\/\/(\*|\*\.[^*/]+|[^*/]+)\/.*$|^about:/,r="object"==typeof navigator&&navigator.userAgent.includes("Firefox/"),i=r?/^(https?|wss?):[/][/][^/]+([/].*)?$/:/^https?:[/][/][^/]+([/].*)?$/,s=/^(https?|file|ftp):[/]+/;function a(...e){return 0===e.length?/$./:e.includes("<all_urls>")?s:e.includes("*://*/*")?i:new RegExp(e.map((e=>function(e){if(!o.test(e))throw new Error(e+" is an invalid pattern, it must match "+String(o));let[,t,n,i]=e.split(/(^[^:]+:[/][/])([^/]+)?/);return t=t.replace("*",r?"(https?|wss?)":"https?").replace(/[/]/g,"[/]"),n=(null!=n?n:"").replace(/^[*][.]/,"([^/]+.)*").replace(/^[*]$/,"[^/]+").replace(/[.]/g,"[.]").replace(/[*]$/g,"[^.]+"),i=i.replace(/[/]/g,"[/]").replace(/[.]/g,"[.]").replace(/[*]/g,".*"),"^"+t+n+"("+i+")?$"}(e))).join("|"))}const c="object"==typeof chrome&&"webNavigation"in chrome;function l(){return function(e){var t,n,o;const r={origins:[],permissions:[]},i=new Set([...null!==(t=e.permissions)&&void 0!==t?t:[],...(null!==(n=e.content_scripts)&&void 0!==n?n:[]).flatMap((e=>{var t;return null!==(t=e.matches)&&void 0!==t?t:[]}))]);e.devtools_page&&!(null===(o=e.optional_permissions)||void 0===o?void 0:o.includes("devtools"))&&i.add("devtools");for(const e of i)e.includes("://")?r.origins.push(e):r.permissions.push(e);return r}(chrome.runtime.getManifest())}const u=/:[/][/][*.]*([^/]+)/;function d(e){return e.split(u)[1]}const m=globalThis.chrome&&new function e(t){return new Proxy(t,{get:(t,n)=>"function"!=typeof t[n]?new e(t[n]):(...e)=>new Promise(((o,r)=>{t[n](...e,(e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):o(e)}))}))})}(globalThis.chrome),f="object"==typeof chrome&&"scripting"in chrome;function h(e){return void 0===e?void 0:[e]}function p({tabId:e,frameId:t,files:n,allFrames:o,matchAboutBlank:r,runAt:i}){for(let s of n)"string"==typeof s&&(s={file:s}),f?chrome.scripting.insertCSS({target:{tabId:e,frameIds:h(t),allFrames:o},files:"file"in s?[s.file]:void 0,css:"code"in s?s.code:void 0}):m.tabs.insertCSS(e,{...s,matchAboutBlank:r,allFrames:o,frameId:t,runAt:null!=i?i:"document_start"})}async function g({tabId:e,frameId:t,files:n,allFrames:o,matchAboutBlank:r,runAt:i}){let s;for(let a of n)if("string"==typeof a&&(a={file:a}),f){if("code"in a)throw new Error("chrome.scripting does not support injecting strings of `code`");chrome.scripting.executeScript({target:{tabId:e,frameIds:h(t),allFrames:o},files:[a.file]})}else"code"in a&&await s,s=m.tabs.executeScript(e,{...a,matchAboutBlank:r,allFrames:o,frameId:t,runAt:i})}async function b(e,t){var n,o,r,i,s,a;const{frameId:c,tabId:l}="object"==typeof e?e:{tabId:e,frameId:0};for(const e of(u=t,Array.isArray(u)?u:[u]))p({tabId:l,frameId:c,files:null!==(n=e.css)&&void 0!==n?n:[],matchAboutBlank:null!==(o=e.matchAboutBlank)&&void 0!==o?o:e.match_about_blank,runAt:null!==(r=e.runAt)&&void 0!==r?r:e.run_at}),g({tabId:l,frameId:c,files:null!==(i=e.js)&&void 0!==i?i:[],matchAboutBlank:null!==(s=e.matchAboutBlank)&&void 0!==s?s:e.match_about_blank,runAt:null!==(a=e.runAt)&&void 0!==a?a:e.run_at});var u;await Promise.all([])}var w,y,v;const I=new Map,A=null!==(v=null===(y=null===(w=null===globalThis||void 0===globalThis?void 0:globalThis.browser)||void 0===w?void 0:w.contentScripts)||void 0===y?void 0:y.register)&&void 0!==v?v:async function(o,r){const{js:i=[],css:s=[],matchAboutBlank:l,matches:u,excludeMatches:d,runAt:m}=o;let{allFrames:f}=o;c?f=!1:f&&console.warn("`allFrames: true` requires the `webNavigation` permission to work correctly: https://github.com/fregante/content-scripts-register-polyfill#permissions");const h=a(...u),p=a(...null!=d?d:[]),g=async(o,r,a=0)=>{h.test(o)&&!p.test(o)&&await async function(t){return e.permissions.contains({origins:[new URL(t).origin+"/*"]})}(o)&&!await async function(n,o){return async function(n,o,...r){const{frameId:i,tabId:s}=function(e){return"object"==typeof e?e:{tabId:e,frameId:0}}(n);if(t){const[e]=await chrome.scripting.executeScript({target:{tabId:s,frameIds:[i]},func:o,args:r});return e?.result}const[a]=await e.tabs.executeScript(s,{code:`(${o.toString()})(...${JSON.stringify(r)})`,frameId:i});return a}(n,(e=>{const t=document[e];return document[e]=!0,t}),JSON.stringify(o))}({tabId:r,frameId:a},{js:i,css:s})&&(async function({tabId:o,frameId:r,files:i,allFrames:s,matchAboutBlank:a,runAt:c}){await Promise.all(i.map((async i=>("string"==typeof i&&(i={file:i}),t?chrome.scripting.insertCSS({target:{tabId:o,frameIds:n(r),allFrames:s},files:"file"in i?[i.file]:void 0,css:"code"in i?i.code:void 0}):e.tabs.insertCSS(o,{...i,matchAboutBlank:a,allFrames:s,frameId:r,runAt:c??"document_start"})))))}({tabId:r,frameId:a,files:s,matchAboutBlank:l,runAt:m}),await async function({tabId:o,frameId:r,files:i,allFrames:s,matchAboutBlank:a,runAt:c}){let l;for(let u of i)if("string"==typeof u&&(u={file:u}),t){if("code"in u)throw new Error("chrome.scripting does not support injecting strings of `code`");chrome.scripting.executeScript({target:{tabId:o,frameIds:n(r),allFrames:s},files:[u.file]})}else"code"in u&&await l,l=e.tabs.executeScript(o,{...u,matchAboutBlank:a,allFrames:s,frameId:r,runAt:c})}({tabId:r,frameId:a,files:i,matchAboutBlank:l,runAt:m}))},b=async(e,{status:t},{url:n})=>{t&&n&&g(n,e)},w=async({tabId:e,frameId:t,url:n})=>{g(n,e,t)};c?chrome.webNavigation.onCommitted.addListener(w):chrome.tabs.onUpdated.addListener(b);const y={async unregister(){c?chrome.webNavigation.onCommitted.removeListener(w):chrome.tabs.onUpdated.removeListener(b)}};return"function"==typeof r&&r(y),y};function x(e){return{file:new URL(e,location.origin).pathname}}async function k({origins:e}){const t=chrome.runtime.getManifest().content_scripts;if(!t)throw new Error("webext-dynamic-content-scripts tried to register scripts on th new host permissions, but no content scripts were found in the manifest.");for(const n of e||[])for(const e of t){const t=A({js:(e.js||[]).map((e=>x(e))),css:(e.css||[]).map((e=>x(e))),allFrames:e.all_frames,matches:[n],excludeMatches:e.matches,runAt:e.run_at});I.set(n,t)}var n,o;o=t,0!==(n=e||[]).length&&chrome.tabs.query({url:n},(e=>{for(const t of e)t.id&&b(t.id,o)}))}(async()=>{k(await async function(e){return new Promise((t=>{chrome.permissions.getAll((n=>{const o=l();t(function(e,t,{strictOrigins:n=!0}={}){var o,r;const i={origins:[],permissions:[]};for(const r of null!==(o=t.origins)&&void 0!==o?o:[])if(!e.origins.includes(r)){if(!n){const t=d(r);if(e.origins.some((e=>d(e)===t)))continue}i.origins.push(r)}for(const n of null!==(r=t.permissions)&&void 0!==r?r:[])e.permissions.includes(n)||i.permissions.push(n);return i}(o,n,e))}))}))}({strictOrigins:!1}))})(),chrome.permissions.onAdded.addListener((e=>{e.origins&&e.origins.length>0&&k(e)})),chrome.permissions.onRemoved.addListener((async({origins:e})=>{if(e&&0!==e.length)for(const[t,n]of I)e.includes(t)&&(await n).unregister()}));function S(e){let t;return()=>(void 0!==t||(t=e()),t)}const _=S((()=>globalThis.location?.protocol.startsWith("http"))),E=S((()=>"object"==typeof globalThis.chrome?.extension)),j=(S((()=>E()&&_())),S((()=>E()&&("/_generated_background_page.html"===location.pathname||chrome.extension?.getBackgroundPage?.()===globalThis.window))));async function $(e,t,...n){const{frameId:o,tabId:r}="object"==typeof e?e:{tabId:e,frameId:0},[i]=await m.tabs.executeScript(r,{code:`(${t.toString()})(...${JSON.stringify(n)})`,frameId:o});return i}async function B(e){const{frameId:t,tabId:n}="object"==typeof e?e:{tabId:e,frameId:0};try{if(0===t){const e=await m.tabs.get(n);if(e.url)return e.url}return await $(e,(()=>location.href))}catch{}}S((()=>{if(!E()||!chrome.runtime.getManifest)return!1;const{options_ui:e}=chrome.runtime.getManifest();return"string"==typeof e?.page&&new URL(e.page,location.origin).pathname===location.pathname})),S((()=>{if(!E()||!chrome.devtools)return!1;const{devtools_page:e}=chrome.runtime.getManifest();return"string"==typeof e&&new URL(e,location.origin).pathname===location.pathname}));const M="webext-domain-permission-toggle:add-permission";let L;async function F(e){const t={checked:!1,enabled:!0};if(e){const n=new URL(e).origin,o=a(...l().origins).test(n);t.enabled=!o,t.checked=o||await async function(e){return m.permissions.contains({origins:[e+"/*"]})}(n)}chrome.contextMenus.update(M,t)}async function T({tabId:e}){var t;F(null!==(t=await B(e))&&void 0!==t?t:"")}async function C({checked:e,menuItemId:t},n){if(t===M)try{await async function(e,t){const n="The browser didn't supply any information about the active tab.";if(!e.url&&t)throw new Error(`Please try again. ${n}`);if(!e.url&&!t)throw new Error(`Couldn't disable the extension on the current tab. ${n}`);const o={origins:[new URL(e.url).origin+"/*"]};t?await m.permissions.request(o)?L.reloadOnSuccess&&$(e.id,(e=>{confirm(e)&&location.reload()}),L.reloadOnSuccess):chrome.contextMenus.update(M,{checked:!1}):m.permissions.remove(o)}(n,e)}catch(e){if(null==n?void 0:n.id){try{await $(n.id,"alert",String(e instanceof Error?e:new Error(e.message)))}catch{alert(e)}F()}throw e}}browser.runtime.onMessage.addListener(((e,t,n)=>{if("octotree_send_request"===e.eventName)return async function({method:e,path:t,body:n,token:o},r){try{const i={"Content-Type":"application/json"};o&&(i.Authorization=`Bearer ${o}`);const s=await fetch(`https://www.octotree.io/api/v1.0/${t.replace(/^\//,"")}`,{headers:i,body:n,method:e}),a=s.headers.get("Content-Type");let c;if(c=/application\/json/i.test(a)?await s.json():await s.text(),!s.ok){const e=new Error(c.message||c.statusText||c);throw e.statusCode=s.status,e}r({responseBody:c,responseStatus:s.status})}catch(e){r({message:e.message,statusCode:e.statusCode})}}(e,n),!0;n()})),browser.runtime.setUninstallURL("https://www.octotree.io/feedback"),function(e){if(!j())throw new Error("webext-domain-permission-toggle can only be called from a background page");if(L)throw new Error("webext-domain-permission-toggle can only be initialized once");const{name:t,optional_permissions:n}=chrome.runtime.getManifest();if(L={title:`Enable ${t} on this domain`,reloadOnSuccess:!1},!0===L.reloadOnSuccess&&(L.reloadOnSuccess=`Do you want to reload this page to apply ${t}?`),!chrome.contextMenus)throw new Error("webext-domain-permission-toggle requires the `contextMenu` permission");const o=null==n?void 0:n.filter((e=>/<all_urls>|\*/.test(e)));if(!o||0===o.length)throw new TypeError("webext-domain-permission-toggle some wildcard hosts to be specified in `optional_permissions`");chrome.contextMenus.remove(M,(()=>chrome.runtime.lastError)),chrome.contextMenus.create({id:M,type:"checkbox",checked:!1,title:L.title,contexts:["page_action","browser_action"],documentUrlPatterns:o}),chrome.contextMenus.onClicked.addListener(C),chrome.tabs.onActivated.addListener(T),chrome.tabs.onUpdated.addListener((async(e,{status:t},{url:n,active:o})=>{var r;o&&"complete"===t&&F(null!==(r=null!=n?n:await B(e))&&void 0!==r?r:"")}))}()})();